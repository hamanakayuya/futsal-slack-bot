name: Post Futsal Reminder

'on':
  schedule:
    - cron: "0 0 * * 1"  # 毎週月曜 0:00(UTC) = 月曜 9:00(JST)
  workflow_dispatch:

jobs:
  send-message:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Post futsal reminder and add reactions
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: CRUMKBS8G
        run: |
          set -euo pipefail

          if [ -z "${SLACK_BOT_TOKEN:-}" ]; then
            echo "ERROR: SLACK_BOT_TOKEN is empty"
            exit 1
          fi

          export TZ=Asia/Tokyo
          FUTSAL_DATE_DISPLAY=$(date -d "next wed" "+%Y-%m-%d(%a)")

          text=$'今週のフットサルのお知らせ⚽\n__DATE__ にフットサルを行います！\n参加する人は:+1:スタンプで反応よろしくお願いします。\n\nまた、\n自分の車で行く人：:車:\n車での送迎が必要な人：:無マーク:\n送迎の車が決まっている人：:感謝:\nで反応よろしくお願いします。\n\n持ち物：体育館用シューズ 飲み物、タオル、着替え\n時間：19:00-21:00\n車ない組は学生駐車場に18:20-30くらいに迎えに行きます。\n＊人数が揃わなかったら、未開催の可能性もあります。\n\nhttps://maps.app.goo.gl/83JPymF25bB3Vt8x8\nhttps://maps.app.goo.gl/xZigqaTk1DdFKdFy6?g_st=ic'

          text="${text/__DATE__/${FUTSAL_DATE_DISPLAY}}"

          payload=$(jq -n \
            --arg channel "$SLACK_CHANNEL" \
            --arg text "$text" \
            '{channel: $channel, text: $text}')

          response=$(curl -sS -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "$payload")

          echo "=== Slack response ==="
          echo "$response"

          ok=$(echo "$response" | jq -r '.ok')
          if [ "$ok" != "true" ]; then
            echo "ERROR: chat.postMessage failed"
            exit 1
          fi

          ts=$(echo "$response" | jq -r '.ts')

          for emoji in "+1" "車" "無マーク" "感謝"; do
            react_payload=$(jq -n \
              --arg name "$emoji" \
              --arg channel "$SLACK_CHANNEL" \
              --arg ts "$ts" \
              '{name: $name, channel: $channel, timestamp: $ts}')

            react_res=$(curl -sS -X POST "https://slack.com/api/reactions.add" \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-type: application/json; charset=utf-8" \
              --data "$react_payload")

            echo "Add reaction $emoji => $react_res"
          done
